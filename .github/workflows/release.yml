name: release
on:
  push:
    tags: ["v*"]

jobs:
  linux-amd64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with: { go-version: "1.23.x" }
      - run: sudo apt-get update && sudo apt-get install -y libffi-dev
      - uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean --skip=publish
      - uses: softprops/action-gh-release@v2
        with:
          files: "dist/*linux-amd64*.tar.gz,dist/*SHA256SUMS*"

  linux-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with: { go-version: "1.23.x" }
      - run: sudo apt-get update && sudo apt-get install -y libffi-dev
      - uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean --skip=publish
      - uses: softprops/action-gh-release@v2
        with:
          files: "dist/*linux-arm64*.tar.gz,dist/*SHA256SUMS*"

  macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with: { go-version: "1.23.x" }
      - run: brew install libffi
      - name: Build with GoReleaser
        run: |
          export PKG_CONFIG_PATH="$(brew --prefix libffi)/lib/pkgconfig:${PKG_CONFIG_PATH}"
          goreleaser release --clean --skip=publish
      - uses: softprops/action-gh-release@v2
        with:
          files: "dist/*darwin-*.tar.gz,dist/*SHA256SUMS*"
