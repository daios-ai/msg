name: Build & Release MindScript

on:
  push:
    tags: ["v*.*.*"]     # tag like v0.3.0 to trigger a release build
  workflow_dispatch:

permissions:
  contents: write        # needed to create/upload the GitHub Release

jobs:
  linux-amd64:
    name: Linux x86_64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: true
      - name: Install deps (libffi)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libffi-dev
      - name: Build + package (host-only)
        run: |
          make clean
          make
      - name: Verify rpath + bundled lib (Linux)
        run: |
          set -euo pipefail
          ls -l dist/mindscript/lib | grep -E 'libffi\.so'
          readelf -d dist/mindscript/bin/msg      | grep -E 'RPATH|RUNPATH' | grep '\$ORIGIN/../lib'
          readelf -d dist/mindscript/bin/msg-lsp  | grep -E 'RPATH|RUNPATH' | grep '\$ORIGIN/../lib'
          ldd dist/mindscript/bin/msg     | grep libffi
          ldd dist/mindscript/bin/msg-lsp | grep libffi
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64
          path: |
            mindscript-linux-x86_64.tar.gz
            mindscript-linux-x86_64.tar.gz.sha256

  linux-arm64:
    name: Raspberry Pi (Linux arm64)
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: true
      - name: Install deps (libffi)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libffi-dev
      - name: Build + package (host-only)
        run: |
          make clean
          make
      - name: Verify rpath + bundled lib (Linux)
        run: |
          set -euo pipefail
          ls -l dist/mindscript/lib | grep -E 'libffi\.so'
          readelf -d dist/mindscript/bin/msg      | grep -E 'RPATH|RUNPATH' | grep '\$ORIGIN/../lib'
          readelf -d dist/mindscript/bin/msg-lsp  | grep -E 'RPATH|RUNPATH' | grep '\$ORIGIN/../lib'
          ldd dist/mindscript/bin/msg     | grep libffi
          ldd dist/mindscript/bin/msg-lsp | grep libffi
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: |
            mindscript-linux-arm64.tar.gz
            mindscript-linux-arm64.tar.gz.sha256

  macos-arm64:
    name: macOS (Apple Silicon)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: true
      - name: Install deps (libffi)
        run: |
          brew update
          brew install libffi pkg-config
      - name: Build + package (host-only)
        env:
          # Makefile already sets PKG_CONFIG_PATH, but keep env visible for clarity.
          PKG_CONFIG_PATH: "$(brew --prefix)/opt/libffi/lib/pkgconfig"
        run: |
          make clean
          make
      - name: Verify rpath + bundled lib (macOS)
        run: |
          set -euo pipefail
          ls -l dist/mindscript/lib | grep -E 'libffi.*\.dylib'
          otool -l dist/mindscript/bin/msg     | awk '/LC_RPATH/{flag=1;next}/Load command/{flag=0}flag' | grep '@loader_path/../lib'
          otool -l dist/mindscript/bin/msg-lsp | awk '/LC_RPATH/{flag=1;next}/Load command/{flag=0}flag' | grep '@loader_path/../lib'
          otool -L dist/mindscript/bin/msg     | grep -E 'libffi.*\.dylib'
          otool -L dist/mindscript/bin/msg-lsp | grep -E 'libffi.*\.dylib'
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: |
            mindscript-macos-arm64.tar.gz
            mindscript-macos-arm64.tar.gz.sha256

  release:
    name: Create GitHub Release
    if: github.ref_type == 'tag'
    needs: [linux-amd64, linux-arm64, macos-arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          files: |
            dist/linux-x86_64/mindscript-linux-x86_64.tar.gz
            dist/linux-x86_64/mindscript-linux-x86_64.tar.gz.sha256
            dist/linux-arm64/mindscript-linux-arm64.tar.gz
            dist/linux-arm64/mindscript-linux-arm64.tar.gz.sha256
            dist/macos-arm64/mindscript-macos-arm64.tar.gz
            dist/macos-arm64/mindscript-macos-arm64.tar.gz.sha256
