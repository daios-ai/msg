=== BEGIN PUBLIC SECTION OF FILE: vm.go ===
// vm.go: minimal bytecode virtual machine for MindScript.
//
// OVERVIEW
// --------
// This file implements a compact, goroutine-safe, stack-based VM that executes
// MindScript bytecode ("Chunk") and returns a result Value. The VM is *intended
// to be internal* to the package: it exposes only the Chunk container in the
// public section; everything else (opcodes, instruction encoding, VM loop) is
// private implementation detail.
//
// Execution model
//   - The interpreter (see interpreter.go) lowers S-expr AST into a Chunk using
//     a small emitter. This VM then executes that Chunk in a given lexical Env.
//   - The VM keeps the public engine surface stable by delegating CALL to
//     Interpreter.Apply semantics via a private helper (applyArgsScoped). That
//     preserves currying, native dispatch, type checks, and call-site scoping.
//   - Runtime errors inside the VM are reported as annotated null Values and
//     surfaced via a vmRuntimeError status to the interpreter.
//
// Instruction encoding (private)
//   - 32-bit instruction: [ opcode:8 | imm:24 ].
//   - Opcodes cover constants/globals, stack ops, property/index access,
//     arithmetic/compare/unary, control flow, and calls.
//   - The emitter (interpreter.go) constructs instruction words via `pack`.
//     Decoding uses `uop` and `uimm`. These are all private to the package.
//
// Data & semantics used by the VM
//   - Value / ValueTag hierarchy, Arr/Bool/Int/Num, Null, MapObject
//   - Env (lexical chain) for resolving globals
//   - Interpreter methods: deepEqual, applyArgsScoped
//   - Negative array indices wrap (Python-like): i := (i%len + len) % len
//   - Property access on maps/modules; index access on arrays/maps
//   - Numeric ops preserve integers where possible; division/mod guard zero;
//     string relational comparisons are supported for <, <=, >, >=.
//   - Control flow: Return yields vmReturn with a Value; fallthrough yields vmOK.
//
// DEPENDENCIES (other files)
// --------------------------
// • interpreter.go
//   - Value/ValueTag/Null/Arr/Bool/Int/Num, MapObject, Env
//   - (ip *Interpreter).deepEqual, (ip *Interpreter).applyArgsScoped
//   - errNull, isNumber, toFloat helpers
//
// • modules.go (not shown here)
//   - Module type and (m *Module).get(name) (used for VTModule property lookups)
//
// • parser.go / lexer.go (indirect; produce AST for the emitter that targets this VM)
// • types.go (indirect; equality of types via deepEqual resolution)
//
// PUBLIC vs PRIVATE
// -----------------
// PUBLIC  : Chunk (bytecode container) — the only stable surface exported here.
// PRIVATE : opcodes, instruction packing, VM loop/state, vmResult/status, helpers.
package mindscript

import (
	"fmt"
	"math"
)

////////////////////////////////////////////////////////////////////////////////
//                                   PUBLIC API
////////////////////////////////////////////////////////////////////////////////

// SourceRef attaches source text and an optional SpanIndex to bytecode.
type SourceRef struct {
	Name  string     // "main.ms", "mod:std/math", "<eval#3>", "<ast>"
	Src   string     // full text
	Spans *SpanIndex // may be nil when unknown
}

// PCMark associates an instruction index with an AST node path.
type PCMark struct {
	PC   int
	Path NodePath
}

// Chunk is an immutable bytecode container executed by the VM.
//
// Layout:
//
//	Code   — instruction stream; each instruction is a 32-bit word where the
//	         high 8 bits encode the opcode and the low 24 bits hold an unsigned
//	         immediate (operand). The encoding details are private to the VM.
//	Consts — constant pool referenced by instructions (e.g., opConst pushes
//	         Consts[k], opLoadGlobal/opGetProp carry string names as VTStr).
//
// Producer & consumer:
//   - Produced by the internal emitter (see interpreter.go) from an S-expr AST.
//   - Consumed only by the VM entry (private) to execute code in an Env.
//
// Stability contract:
//   - The existence of Chunk and its fields is stable for code that needs to
//     hand bytecode across subsystems within this package. The instruction set
//     and encoding are *not* public API.
type Chunk struct {
	Code   []uint32
	Consts []Value
	Src    *SourceRef
	Marks  []PCMark
}

=== END PUBLIC SECTION FOR FILE: vm.go ===

